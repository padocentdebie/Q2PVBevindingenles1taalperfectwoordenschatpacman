<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BTV Police Training</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        :root { --cobalt: #0044ff; --gold: #f0db4f; --danger: #ff0000; --success: #2ecc71; --bg: #000; }
        body { font-family: sans-serif; background: var(--bg); color: #eee; margin: 0; display: flex; flex-direction: column; align-items: center; touch-action: none; overflow: hidden; }
        .hud { width: 100%; max-width: 400px; padding: 10px; display: flex; justify-content: space-between; color: var(--gold); background: #111; border-bottom: 3px solid var(--cobalt); }
        #game-container { position: relative; border: 4px solid #222; }
        canvas { display: block; background: #000; }
        #quiz-box { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            width: 85%; background: #fff; border-radius: 12px; padding: 20px; 
            text-align: center; display: none; z-index: 100; color: #000; border: 5px solid var(--cobalt);
        }
        .optie { display: block; width: 100%; padding: 12px; margin: 8px 0; background: #f0f0f0; border: 2px solid #ccc; cursor: pointer; border-radius: 8px; font-weight: bold; }
        .correct { background: var(--success) !important; color: #fff; }
        .fout { background: var(--danger) !important; color: #fff; }
        .btn { background: var(--cobalt); color: white; padding: 12px; width: 100%; border: none; font-weight: bold; border-radius: 6px; cursor: pointer; text-transform: uppercase; }
    </style>
</head>
<body>

<div id="login" style="margin-top: 50px; text-align: center;">
    <h1 style="color: var(--gold);">BTV PAC-MAN</h1>
    <input type="text" id="vnaam" placeholder="AGENT NAAM..." style="padding:15px; width:200px; text-align:center;"><br><br>
    <button class="btn" style="width:230px;" onclick="initSessie()">START TRAINING</button>
</div>

<div id="main-game" style="display:none;">
    <div class="hud"><span>PUNTEN: <span id="scr-val">0</span></span><span>HP: <span id="lvn-val">5</span></span></div>
    <div id="game-container">
        <canvas id="gameCanvas"></canvas>
        <div id="quiz-box">
            <div id="vraag" style="font-size:1.2rem; font-weight:800; margin-bottom:15px;"></div>
            <div id="optie-container"></div>
            <div id="prog-val" style="font-size:0.8rem; margin:10px 0;">Voortgang: 0 / 5</div>
            <button id="btn-reset" class="btn" style="display:none; background:var(--danger);" onclick="nextQ()">FOUT: RESET NAAR 0</button>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = { apiKey: "AIzaSyBEod8zm1jvvkmPbe6cA_SQo2U_esC9yTY", databaseURL: "https://aangiftebotje-default-rtdb.europe-west1.firebasedatabase.app", projectId: "aangiftebotje" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let dynamicWords = [], vnaam, sRef, score = 0, levens = 5, frame = 0, inGame = false, quizCount = 0;
    let canvas, ctx, tileSize, pacman = { x: 9, y: 9, dir: {x:0, y:0}, nextDir: {x:0, y:0}, rotation: 0 };
    let dots = [], walls = [], ghosts = [], lightOn = true;

    // Maze: 1=Muur, 0=Bolletje, 2=Leeg/Tunnel
    const mazeLayout = [
        [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
        [1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,1],
        [1,0,1,1,0,1,1,1,0,1,0,1,1,1,0,1,1,0,1],
        [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
        [1,1,0,1,0,1,1,1,1,1,1,1,1,1,0,1,0,1,1],
        [2,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,0,2], // RIJ 5 = TUNNEL
        [1,1,1,1,0,1,1,1,1,1,1,1,1,1,0,1,1,1,1],
        [1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,1],
        [1,0,1,1,0,1,1,1,0,1,0,1,1,1,0,1,1,0,1],
        [1,0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0,0,1],
        [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
    ];

    function initSessie() {
        vnaam = document.getElementById('vnaam').value.trim();
        if(!vnaam) return alert("Naam invullen.");
        db.ref('woorden').once('value', snap => {
            if(!snap.exists()) return alert("Database leeg!");
            dynamicWords = Object.values(snap.val());
            document.getElementById('login').style.display = 'none';
            document.getElementById('main-game').style.display = 'block';
            setupCanvas();
            startQuiz();
        });
    }

    function startQuiz() {
        inGame = false; quizCount = 0;
        document.getElementById('quiz-box').style.display = 'block';
        nextQ();
    }

    function nextQ() {
        if(quizCount >= 5) {
            document.getElementById('quiz-box').style.display = 'none';
            inGame = true; initLevel(); requestAnimationFrame(gameLoop);
            return;
        }
        document.getElementById('btn-reset').style.display = 'none';
        document.getElementById('prog-val').innerText = `Voortgang: ${quizCount} / 5`;
        const q = dynamicWords[Math.floor(Math.random()*dynamicWords.length)];
        const opties = [q.m, "Fout antwoord A", "Fout antwoord B"].sort(() => 0.5 - Math.random());
        
        document.getElementById('vraag').innerText = q.v;
        const cont = document.getElementById('optie-container'); cont.innerHTML = '';
        
        opties.forEach(o => {
            const b = document.createElement('button'); b.className = 'optie'; b.innerText = o;
            b.onclick = () => {
                if(o === q.m) { b.classList.add('correct'); setTimeout(() => { quizCount++; nextQ(); }, 600); }
                else { b.classList.add('fout'); quizCount = 0; document.getElementById('btn-reset').style.display = 'block'; }
            };
            cont.appendChild(b);
        });
    }

    function setupCanvas() {
        canvas = document.getElementById('gameCanvas'); ctx = canvas.getContext('2d');
        tileSize = 20; canvas.width = 19 * tileSize; canvas.height = 11 * tileSize;
        window.addEventListener('keydown', e => {
            if(e.key.includes("Up")) pacman.nextDir = {x:0, y:-1};
            if(e.key.includes("Down")) pacman.nextDir = {x:0, y:1};
            if(e.key.includes("Left")) pacman.nextDir = {x:-1, y:0};
            if(e.key.includes("Right")) pacman.nextDir = {x:1, y:0};
        });
    }

    function initLevel() {
        dots = []; walls = [];
        for(let y=0; y<11; y++) for(let x=0; x<19; x++) {
            if(mazeLayout[y][x] === 1) walls.push({x, y});
            else if(mazeLayout[y][x] === 0) dots.push({x, y, eaten: false});
        }
        pacman.x = 9; pacman.y = 9;
        ghosts = [{x:1, y:1, color:'red'}, {x:17, y:1, color:'pink'}];
    }

    function canMove(x, y) {
        if(x < 0 || x > 18) return true; // Tunnel toestaan
        return !walls.some(w => w.x === Math.round(x) && w.y === Math.round(y));
    }

    function gameLoop() {
        if(!inGame) return;
        frame++; if(frame % 10 === 0) lightOn = !lightOn;
        ctx.fillStyle = '#000'; ctx.fillRect(0,0,canvas.width,canvas.height);

        // Teken muren
        ctx.fillStyle = '#0022aa';
        walls.forEach(w => ctx.fillRect(w.x*tileSize+1, w.y*tileSize+1, tileSize-2, tileSize-2));

        // Teken bolletjes
        ctx.fillStyle = '#fff';
        dots.forEach(d => { if(!d.eaten) { ctx.beginPath(); ctx.arc(d.x*tileSize+tileSize/2, d.y*tileSize+tileSize/2, 2, 0, 7); ctx.fill(); }});

        // Beweging Pacman
        if(Number.isInteger(pacman.x) && Number.isInteger(pacman.y)) {
            let d = dots.find(dot => dot.x === pacman.x && dot.y === pacman.y && !dot.eaten);
            if(d) { d.eaten = true; score += 10; document.getElementById('scr-val').innerText = score; }
            if(canMove(pacman.x + pacman.nextDir.x, pacman.y + pacman.nextDir.y)) pacman.dir = pacman.nextDir;
            if(!canMove(pacman.x + pacman.dir.x, pacman.y + pacman.dir.y)) pacman.dir = {x:0, y:0};
        }
        pacman.x += pacman.dir.x * 0.1; pacman.y += pacman.dir.y * 0.1;
        pacman.x = Math.round(pacman.x * 10) / 10; pacman.y = Math.round(pacman.y * 10) / 10;

        // Tunnel
        if(pacman.x < 0) pacman.x = 18; if(pacman.x > 18) pacman.x = 0;

        // Teken Pacman
        ctx.fillStyle = 'yellow'; ctx.beginPath();
        ctx.arc(pacman.x*tileSize+tileSize/2, pacman.y*tileSize+tileSize/2, 8, 0, 7); ctx.fill();
        
        // Blauw zwaailichtje
        if(lightOn) {
            ctx.fillStyle = '#00f'; ctx.beginPath();
            ctx.arc(pacman.x*tileSize+tileSize/2, pacman.y*tileSize+tileSize/2 - 4, 4, 0, 7); ctx.fill();
        }

        // Spookjes (volgen paden, geen muren)
        ghosts.forEach(g => {
            let dx = pacman.x - g.x; let dy = pacman.y - g.y;
            let moveX = dx > 0 ? 0.05 : -0.05;
            let moveY = dy > 0 ? 0.05 : -0.05;

            if(canMove(g.x + moveX, g.y)) g.x += moveX;
            else if(canMove(g.x, g.y + moveY)) g.y += moveY;

            ctx.fillStyle = g.color; ctx.beginPath();
            ctx.arc(g.x*tileSize+tileSize/2, g.y*tileSize+tileSize/2, 8, 0, 7); ctx.fill();

            if(Math.hypot(pacman.x-g.x, pacman.y-g.y) < 0.6) {
                levens--; document.getElementById('lvn-val').innerText = levens;
                if(levens <= 0) location.reload(); else startQuiz();
            }
        });

        requestAnimationFrame(gameLoop);
    }
</script>
</body>
</html>
